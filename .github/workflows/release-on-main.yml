name: Create release on main

on:
  push:
    branches: [main]

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Resolve version
        id: version
        run: |
          VERSION=$(grep -E '^version = ' Cargo.toml | head -n 1 | sed -E 's/.*"([^"]+)".*/\1/')
          if [[ -z "$VERSION" ]]; then
            echo "Failed to resolve version from Cargo.toml" >&2
            exit 1
          fi
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
      - name: Check version change
        id: version_change
        run: |
          if git rev-parse HEAD^ >/dev/null 2>&1; then
            PREV=$(git show HEAD^:Cargo.toml | grep -E '^version = ' | head -n 1 | sed -E 's/.*"([^"]+)".*/\1/')
            if [[ "$PREV" == "${{ steps.version.outputs.version }}" ]]; then
              echo "changed=false" >> "$GITHUB_OUTPUT"
              exit 0
            fi
          fi
          echo "changed=true" >> "$GITHUB_OUTPUT"
      - name: Create release if missing
        env:
          VERSION: ${{ steps.version.outputs.version }}
        if: ${{ steps.version_change.outputs.changed == 'true' }}
        run: |
          git fetch --tags
          TAG="v${VERSION}"
          if git tag -l "$TAG" | grep -q "$TAG"; then
            echo "Tag $TAG already exists; skipping release."
            exit 0
          fi
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
        id: tag
      - name: Publish release
        if: ${{ steps.tag.outputs.tag != '' }}
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          name: ${{ steps.tag.outputs.tag }}
          target_commitish: ${{ github.sha }}
          generate_release_notes: true
      - name: Trigger release build
        if: ${{ steps.tag.outputs.tag != '' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          curl -sS -X POST \
            -H "Authorization: token ${GITHUB_TOKEN}" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${{ github.repository }}/actions/workflows/release-build.yml/dispatches" \
            -d "{\"ref\":\"main\",\"inputs\":{\"tag\":\"${{ steps.tag.outputs.tag }}\"}}"
