import { ListView } from "std-widgets.slint";
import { WavRow } from "types.slint";

export component WavListPanel inherits Rectangle {
    in-out property <[WavRow]> wavs_trash;
    in-out property <[WavRow]> wavs_neutral;
    in-out property <[WavRow]> wavs_keep;
    in-out property <string> dragging_sample_path: "";
    in-out property <string> drag_preview_label: "";
    in-out property <length> drag_preview_x: 0px;
    in-out property <length> drag_preview_y: 0px;
    in-out property <bool> drag_preview_visible: false;
    property <string> pending_path: "";
    property <string> pending_label: "";
    property <length> drag_start_x: 0px;
    property <length> drag_start_y: 0px;
    property <bool> drag_started: false;
    property <length> cursor_x: 0px;
    property <length> cursor_y: 0px;
    in-out property <int> selected_trash: -1;
    in-out property <int> selected_neutral: -1;
    in-out property <int> selected_keep: -1;
    in-out property <string> loaded_wav_path: "";
    callback wav_clicked(string);

    public function scroll_to(tag: int, index: int) {
        if index < 0 { return; }
        if tag == 0 {
            scroll_trash(index);
        } else if tag == 2 {
            scroll_keep(index);
        } else {
            scroll_neutral(index);
        }
    }

    function scroll_trash(index: int) {
        if index < 0 { return; }
        let row_height = 32px;
        let visible = trash_list.visible-height;
        let desired_top = index * row_height;
        let desired_bottom = desired_top + row_height;
        let current_top = -trash_list.viewport-y;
        let margin = 6px;
        if desired_top < current_top + margin {
            let target = desired_top - margin;
            let clamped = target < 0px ? 0px : target;
            trash_list.viewport-y = -clamped;
        } else if desired_bottom > current_top + visible - margin {
            let target = desired_bottom - visible + margin;
            let clamped = target < 0px ? 0px : target;
            trash_list.viewport-y = -clamped;
        }
    }

    function scroll_neutral(index: int) {
        if index < 0 { return; }
        let row_height = 32px;
        let visible = neutral_list.visible-height;
        let desired_top = index * row_height;
        let desired_bottom = desired_top + row_height;
        let current_top = -neutral_list.viewport-y;
        let margin = 6px;
        if desired_top < current_top + margin {
            let target = desired_top - margin;
            let clamped = target < 0px ? 0px : target;
            neutral_list.viewport-y = -clamped;
        } else if desired_bottom > current_top + visible - margin {
            let target = desired_bottom - visible + margin;
            let clamped = target < 0px ? 0px : target;
            neutral_list.viewport-y = -clamped;
        }
    }

    function scroll_keep(index: int) {
        if index < 0 { return; }
        let row_height = 32px;
        let visible = keep_list.visible-height;
        let desired_top = index * row_height;
        let desired_bottom = desired_top + row_height;
        let current_top = -keep_list.viewport-y;
        let margin = 6px;
        if desired_top < current_top + margin {
            let target = desired_top - margin;
            let clamped = target < 0px ? 0px : target;
            keep_list.viewport-y = -clamped;
        } else if desired_bottom > current_top + visible - margin {
            let target = desired_bottom - visible + margin;
            let clamped = target < 0px ? 0px : target;
            keep_list.viewport-y = -clamped;
        }
    }

    vertical-stretch: 1;
    border-width: 1px;
    border-color: #404040;
    background: #0f0f0f;
    border-radius: 6px;

    VerticalLayout {
        padding: 8px;
        spacing: 6px;

        Text {
            text: "Samples";
            color: #d0d0d0;
        }

        HorizontalLayout {
            spacing: 8px;
            vertical-stretch: 1;

            // Trash column
            trash_column := Rectangle {
                horizontal-stretch: 1;
                vertical-stretch: 1;
                background: #0b0b0b;
                border-width: 1px;
                border-color: #303030;
                border-radius: 6px;
                VerticalLayout {
                    padding: 8px;
                    spacing: 6px;
                    Text { text: "Trash"; color: #c68f8f; }
                    trash_list := ListView {
                        vertical-stretch: 1;
                        min-height: 200px;
                        for file[i] in root.wavs_trash: row_trash := Rectangle {
                            height: 32px;
                            horizontal-stretch: 1;
                            clip: true;
                            cache-rendering-hint: true;
                            background: ta_trash.pressed ? file.pressed_bg :
                                (ta_trash.has-hover ? file.hover_bg : file.bg);
                            border-width: file.selected ? 1px : 0px;
                            border-color: file.border_color;
                            Rectangle {
                                x: 0px;
                                y: 0px;
                                width: parent.width;
                                height: parent.height;
                                background: file.overlay;
                                border-radius: 6px;
                            }
                            HorizontalLayout {
                                padding: 8px;
                                spacing: 8px;
                                Rectangle {
                                    width: 4px;
                                    height: parent.height - 6px;
                                    background: file.indicator_color;
                                    border-radius: 2px;
                                }
                                Text {
                                    text: file.name;
                                    color: #e0e0e0;
                                    horizontal-alignment: left;
                                    horizontal-stretch: 1;
                                }
                                if file.tag_label != "" : Rectangle {
                                    height: 20px;
                                    border-radius: 10px;
                                    background: file.tag_bg;
                                    HorizontalLayout {
                                        padding-left: 8px;
                                        padding-right: 8px;
                                        Text {
                                            text: file.tag_label;
                                            color: file.tag_fg;
                                            horizontal-alignment: center;
                                            vertical-alignment: center;
                                        }
                                    }
                                }
                            }
                            ta_trash := TouchArea {
                                width: parent.width;
                                height: parent.height;
                                pointer-event(event) => {
                                    if event.kind == PointerEventKind.down {
                                        root.pending_path = file.path;
                                        root.pending_label = file.name;
                                        root.drag_started = false;
                                        root.drag_preview_visible = false;
                                        let pos_x = trash_column.x + row_trash.x + self.mouse-x;
                                        let pos_y = trash_column.y + row_trash.y + self.mouse-y;
                                        root.drag_start_x = pos_x;
                                        root.drag_start_y = pos_y;
                                        root.cursor_x = pos_x;
                                        root.cursor_y = pos_y;
                                    } else if event.kind == PointerEventKind.move && root.pending_path != "" {
                                        let pos_x = trash_column.x + row_trash.x + self.mouse-x;
                                        let pos_y = trash_column.y + row_trash.y + self.mouse-y;
                                        root.cursor_x = pos_x;
                                        root.cursor_y = pos_y;
                                        if !root.drag_started
                                            && (pos_x > root.drag_start_x + 6px
                                                || pos_x + 6px < root.drag_start_x
                                                || pos_y > root.drag_start_y + 6px
                                                || pos_y + 6px < root.drag_start_y)
                                        {
                                            root.drag_started = true;
                                            root.dragging_sample_path = root.pending_path;
                                            root.drag_preview_label = root.pending_label;
                                            root.drag_preview_visible = true;
                                        }
                                        if root.drag_started {
                                            root.drag_preview_x = root.cursor_x;
                                            root.drag_preview_y = root.cursor_y;
                                        }
                                    } else if event.kind == PointerEventKind.up {
                                        let was_dragging = root.drag_started;
                                        root.drag_preview_visible = false;
                                        root.drag_started = false;
                                        if !was_dragging {
                                            root.dragging_sample_path = "";
                                        }
                                        root.pending_path = "";
                                    } else if event.kind == PointerEventKind.cancel {
                                        root.drag_preview_visible = false;
                                        root.drag_started = false;
                                        root.pending_path = "";
                                        root.dragging_sample_path = "";
                                    }
                                }
                                clicked => { root.wav_clicked(file.path); }
                            }
                        }
                    }
                }
            }

            // Neutral column
            neutral_column := Rectangle {
                horizontal-stretch: 1;
                vertical-stretch: 1;
                background: #0b0b0b;
                border-width: 1px;
                border-color: #303030;
                border-radius: 6px;
                VerticalLayout {
                    padding: 8px;
                    spacing: 6px;
                    Text { text: "Samples"; color: #d0d0d0; }
                    neutral_list := ListView {
                        vertical-stretch: 1;
                        min-height: 200px;
                        for file[i] in root.wavs_neutral: row_neutral := Rectangle {
                            height: 32px;
                            horizontal-stretch: 1;
                            clip: true;
                            cache-rendering-hint: true;
                            background: ta_neutral.pressed ? file.pressed_bg :
                                (ta_neutral.has-hover ? file.hover_bg : file.bg);
                            border-width: file.selected ? 1px : 0px;
                            border-color: file.border_color;
                            Rectangle {
                                x: 0px;
                                y: 0px;
                                width: parent.width;
                                height: parent.height;
                                background: file.overlay;
                                border-radius: 6px;
                            }
                            HorizontalLayout {
                                padding: 8px;
                                spacing: 8px;
                                Rectangle {
                                    width: 4px;
                                    height: parent.height - 6px;
                                    background: file.indicator_color;
                                    border-radius: 2px;
                                }
                                Text {
                                    text: file.name;
                                    color: #e0e0e0;
                                    horizontal-alignment: left;
                                    horizontal-stretch: 1;
                                }
                                if file.tag_label != "" : Rectangle {
                                    height: 20px;
                                    border-radius: 10px;
                                    background: file.tag_bg;
                                    HorizontalLayout {
                                        padding-left: 8px;
                                        padding-right: 8px;
                                        Text {
                                            text: file.tag_label;
                                            color: file.tag_fg;
                                            horizontal-alignment: center;
                                            vertical-alignment: center;
                                        }
                                    }
                                }
                            }
                            ta_neutral := TouchArea {
                                width: parent.width;
                                height: parent.height;
                                pointer-event(event) => {
                                    if event.kind == PointerEventKind.down {
                                        root.pending_path = file.path;
                                        root.pending_label = file.name;
                                        root.drag_started = false;
                                        root.drag_preview_visible = false;
                                        let pos_x = neutral_column.x + row_neutral.x + self.mouse-x;
                                        let pos_y = neutral_column.y + row_neutral.y + self.mouse-y;
                                        root.drag_start_x = pos_x;
                                        root.drag_start_y = pos_y;
                                        root.cursor_x = pos_x;
                                        root.cursor_y = pos_y;
                                    } else if event.kind == PointerEventKind.move && root.pending_path != "" {
                                        let pos_x = neutral_column.x + row_neutral.x + self.mouse-x;
                                        let pos_y = neutral_column.y + row_neutral.y + self.mouse-y;
                                        root.cursor_x = pos_x;
                                        root.cursor_y = pos_y;
                                        if !root.drag_started
                                            && (pos_x > root.drag_start_x + 6px
                                                || pos_x + 6px < root.drag_start_x
                                                || pos_y > root.drag_start_y + 6px
                                                || pos_y + 6px < root.drag_start_y)
                                        {
                                            root.drag_started = true;
                                            root.dragging_sample_path = root.pending_path;
                                            root.drag_preview_label = root.pending_label;
                                            root.drag_preview_visible = true;
                                        }
                                        if root.drag_started {
                                            root.drag_preview_x = root.cursor_x;
                                            root.drag_preview_y = root.cursor_y;
                                        }
                                    } else if event.kind == PointerEventKind.up {
                                        let was_dragging = root.drag_started;
                                        root.drag_preview_visible = false;
                                        root.drag_started = false;
                                        if !was_dragging {
                                            root.dragging_sample_path = "";
                                        }
                                        root.pending_path = "";
                                    } else if event.kind == PointerEventKind.cancel {
                                        root.drag_preview_visible = false;
                                        root.drag_started = false;
                                        root.pending_path = "";
                                        root.dragging_sample_path = "";
                                    }
                                }
                                clicked => { root.wav_clicked(file.path); }
                            }
                        }
                    }
                }
            }

            // Keep column
            keep_column := Rectangle {
                horizontal-stretch: 1;
                vertical-stretch: 1;
                background: #0b0b0b;
                border-width: 1px;
                border-color: #303030;
                border-radius: 6px;
                VerticalLayout {
                    padding: 8px;
                    spacing: 6px;
                    Text { text: "Keep"; color: #9ec9a7; }
                    keep_list := ListView {
                        vertical-stretch: 1;
                        min-height: 200px;
                        for file[i] in root.wavs_keep: row_keep := Rectangle {
                            height: 32px;
                            horizontal-stretch: 1;
                            clip: true;
                            cache-rendering-hint: true;
                            background: ta_keep.pressed ? file.pressed_bg :
                                (ta_keep.has-hover ? file.hover_bg : file.bg);
                            border-width: file.selected ? 1px : 0px;
                            border-color: file.border_color;
                            Rectangle {
                                x: 0px;
                                y: 0px;
                                width: parent.width;
                                height: parent.height;
                                background: file.overlay;
                                border-radius: 6px;
                            }
                            HorizontalLayout {
                                padding: 8px;
                                spacing: 8px;
                                Rectangle {
                                    width: 4px;
                                    height: parent.height - 6px;
                                    background: file.indicator_color;
                                    border-radius: 2px;
                                }
                                Text {
                                    text: file.name;
                                    color: #e0e0e0;
                                    horizontal-alignment: left;
                                    horizontal-stretch: 1;
                                }
                                if file.tag_label != "" : Rectangle {
                                    height: 20px;
                                    border-radius: 10px;
                                    background: file.tag_bg;
                                    HorizontalLayout {
                                        padding-left: 8px;
                                        padding-right: 8px;
                                        Text {
                                            text: file.tag_label;
                                            color: file.tag_fg;
                                            horizontal-alignment: center;
                                            vertical-alignment: center;
                                        }
                                    }
                                }
                            }
                            ta_keep := TouchArea {
                                width: parent.width;
                                height: parent.height;
                                pointer-event(event) => {
                                    if event.kind == PointerEventKind.down {
                                        root.pending_path = file.path;
                                        root.pending_label = file.name;
                                        root.drag_started = false;
                                        root.drag_preview_visible = false;
                                        let pos_x = keep_column.x + row_keep.x + self.mouse-x;
                                        let pos_y = keep_column.y + row_keep.y + self.mouse-y;
                                        root.drag_start_x = pos_x;
                                        root.drag_start_y = pos_y;
                                        root.cursor_x = pos_x;
                                        root.cursor_y = pos_y;
                                    } else if event.kind == PointerEventKind.move && root.pending_path != "" {
                                        let pos_x = keep_column.x + row_keep.x + self.mouse-x;
                                        let pos_y = keep_column.y + row_keep.y + self.mouse-y;
                                        root.cursor_x = pos_x;
                                        root.cursor_y = pos_y;
                                        if !root.drag_started
                                            && (pos_x > root.drag_start_x + 6px
                                                || pos_x + 6px < root.drag_start_x
                                                || pos_y > root.drag_start_y + 6px
                                                || pos_y + 6px < root.drag_start_y)
                                        {
                                            root.drag_started = true;
                                            root.dragging_sample_path = root.pending_path;
                                            root.drag_preview_label = root.pending_label;
                                            root.drag_preview_visible = true;
                                        }
                                        if root.drag_started {
                                            root.drag_preview_x = root.cursor_x;
                                            root.drag_preview_y = root.cursor_y;
                                        }
                                    } else if event.kind == PointerEventKind.up {
                                        let was_dragging = root.drag_started;
                                        root.drag_preview_visible = false;
                                        root.drag_started = false;
                                        if !was_dragging {
                                            root.dragging_sample_path = "";
                                        }
                                        root.pending_path = "";
                                    } else if event.kind == PointerEventKind.cancel {
                                        root.drag_preview_visible = false;
                                        root.drag_started = false;
                                        root.pending_path = "";
                                        root.dragging_sample_path = "";
                                    }
                                }
                                clicked => { root.wav_clicked(file.path); }
                            }
                        }
                    }
                }
            }
        }
    }

    if root.drag_preview_visible : Rectangle {
        x: root.drag_preview_x + 8px;
        y: root.drag_preview_y + 8px;
        width: 180px;
        height: 34px;
        z: 15;
        background: #1a2733ee;
        border-width: 1px;
        border-color: #2f6fb1;
        border-radius: 6px;
        HorizontalLayout {
            padding: 10px;
            spacing: 8px;
            Rectangle {
                width: 8px;
                height: 8px;
                background: #5ab0ff;
                border-radius: 4px;
            }
            Text {
                text: root.drag_preview_label != "" ? root.drag_preview_label : "Sample";
                color: #e0e0e0;
                horizontal-stretch: 1;
            }
        }
    }
}
