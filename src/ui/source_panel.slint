import { ListView } from "std-widgets.slint";
import { SourceRow } from "types.slint";

export component SourcePanel inherits Rectangle {
    in-out property <[SourceRow]> sources;
    in-out property <int> selected_source: -1;
    in-out property <int> source_menu_index: -1;
    callback add_source();
    callback source_selected(int);
    callback source_update_requested(int);
    callback source_remove_requested(int);

    public function scroll_to(index: int) {
        if index < 0 { return; }
        let row_height = 36px;
        let visible = source_list.visible-height;
        let desired_top = index * row_height;
        let desired_bottom = desired_top + row_height;
        let current_top = -source_list.viewport-y;
        let margin = 6px;

        if desired_top < current_top + margin {
            let target = desired_top - margin;
            let clamped = target < 0px ? 0px : target;
            source_list.viewport-y = -clamped;
        } else if desired_bottom > current_top + visible - margin {
            let target = desired_bottom - visible + margin;
            let clamped = target < 0px ? 0px : target;
            source_list.viewport-y = -clamped;
        }
    }

    width: 220px;
    vertical-stretch: 1;
    background: #101010;
    border-width: 1px;
    border-color: #303030;
    border-radius: 6px;

    VerticalLayout {
        padding: 8px;
        spacing: 8px;

        HorizontalLayout {
            spacing: 6px;
            Text {
                text: "Sources";
                color: #e0e0e0;
            }
            Rectangle {
                width: 20px;
                height: 20px;
                background: #1f8bff;
                border-radius: 4px;
                HorizontalLayout {
                    Text {
                        text: "+";
                        width: parent.width;
                        height: parent.height;
                        horizontal-alignment: center;
                        vertical-alignment: center;
                        color: #ffffff;
                    }
                }
                TouchArea {
                    width: parent.width;
                    height: parent.height;
                    clicked => { root.add_source(); }
                }
            }
        }

        source_list := ListView {
            vertical-stretch: 1;
            min-height: 200px;
            for source[i] in root.sources: Rectangle {
                height: 36px;
                horizontal-stretch: 1;
                cache-rendering-hint: true;
                background: ta_source.pressed ? #1f1f1f : (i == root.selected_source ? #1a2733 : (ta_source.has-hover ? #141414 : #101010));
                border-width: i == root.selected_source ? 1px : 0px;
                border-color: #2f6fb1;
                HorizontalLayout {
                    padding: 8px;
                    spacing: 6px;
                    Text {
                        text: source.name;
                        color: #e0e0e0;
                    }
                    Rectangle {
                        horizontal-stretch: 1;
                        height: 1px;
                        background: #00000000;
                    }
                    Rectangle {
                        width: 22px;
                        height: 22px;
                        background: #1b1b1b;
                        border-radius: 4px;
                        border-width: 1px;
                        border-color: #2f2f2f;
                        Text {
                            text: "â‹®";
                            horizontal-alignment: center;
                            vertical-alignment: center;
                            color: #c8c8c8;
                            width: parent.width;
                            height: parent.height;
                        }
                        TouchArea {
                            width: parent.width;
                            height: parent.height;
                            clicked => { root.source_menu_index = i; }
                        }
                    }
                }
                ta_source := TouchArea {
                    width: parent.width;
                    height: parent.height;
                    clicked => {
                        root.source_menu_index = -1;
                        root.source_selected(i);
                    }
                    pointer-event(event) => {
                        if event.kind == PointerEventKind.up
                            && event.button == PointerEventButton.right
                        {
                            root.source_selected(i);
                            root.source_menu_index = i;
                        }
                    }
                }
                if root.source_menu_index == i : Rectangle {
                    x: parent.width - self.width - 8px;
                    y: parent.height;
                    width: 160px;
                    background: #0f1115;
                    border-width: 1px;
                    border-color: #2a3a50;
                    border-radius: 6px;
                    z: 5;
                    VerticalLayout {
                        padding: 6px;
                        spacing: 6px;
                        Rectangle {
                            height: 28px;
                            background: #162235;
                            border-radius: 4px;
                            Text {
                                text: "Rescan / Find changes";
                                color: #d8dfe8;
                                vertical-alignment: center;
                                horizontal-alignment: center;
                                width: parent.width;
                                height: parent.height;
                            }
                            TouchArea {
                                width: parent.width;
                                height: parent.height;
                                clicked => {
                                    root.source_menu_index = -1;
                                    root.source_update_requested(i);
                                }
                            }
                        }
                        Rectangle {
                            height: 28px;
                            background: #251919;
                            border-radius: 4px;
                            Text {
                                text: "Remove source";
                                color: #e8c8c8;
                                vertical-alignment: center;
                                horizontal-alignment: center;
                                width: parent.width;
                                height: parent.height;
                            }
                            TouchArea {
                                width: parent.width;
                                height: parent.height;
                                clicked => {
                                    root.source_menu_index = -1;
                                    root.source_remove_requested(i);
                                }
                            }
                        }
                    }
                }
            }
        }
    }
}
