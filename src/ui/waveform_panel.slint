export component WaveformPanel inherits Rectangle {
    in-out property <image> waveform;
    in-out property <float> playhead_position: 0.0;
    in-out property <bool> playhead_visible: false;
    in-out property <bool> selection_visible: false;
    in-out property <float> selection_start: 0.0;
    in-out property <float> selection_end: 0.0;
    in-out property <bool> loop_enabled: false;
    in-out property <bool> selection_drag_active: false;
    in-out property <bool> selection_drag_moved: false;
    callback seek_requested(float);
    callback selection_drag_started(float);
    callback selection_drag_updated(float);
    callback selection_drag_finished();
    callback selection_clear_requested();
    callback selection_handle_pressed(bool);
    callback loop_toggled(bool);

    horizontal-stretch: 1;
    border-width: 1px;
    border-color: #404040;
    background: #101010;
    border-radius: 6px;

    VerticalLayout {
        spacing: 8px;
        padding: 8px;

        HorizontalLayout {
            spacing: 8px;
            Text {
                text: "Waveform Viewer";
                horizontal-alignment: left;
                color: #e0e0e0;
                font-size: 18px;
                horizontal-stretch: 1;
            }
            Rectangle {
                width: 126px;
                height: 26px;
                border-radius: 13px;
                background: root.loop_enabled ? #1f2f25 : #181818;
                border-width: 1px;
                border-color: root.loop_enabled ? #3a8f64 : #303030;
                HorizontalLayout {
                    padding-left: 10px;
                    padding-right: 10px;
                    spacing: 8px;
                    Text {
                        text: "Loop Playback";
                        color: root.loop_enabled ? #7fddb4 : #c8c8c8;
                        vertical-alignment: center;
                        font-size: 12px;
                    }
                    Rectangle {
                        width: 18px;
                        height: 18px;
                        border-radius: 9px;
                        background: root.loop_enabled ? #3fbf86 : #202020;
                        border-width: 1px;
                        border-color: root.loop_enabled ? #62e7a3 : #404040;
                    }
                }
                TouchArea {
                    width: parent.width;
                    height: parent.height;
                    clicked => {
                        root.loop_enabled = !root.loop_enabled;
                        root.loop_toggled(root.loop_enabled);
                    }
                }
            }
        }

        wave_area := Rectangle {
            horizontal-stretch: 1;
            preferred-height: 260px;
            min-height: 220px;
            vertical-stretch: 1;
            clip: true;

            Image {
                source: root.waveform;
                width: parent.width;
                height: parent.height;
                image-fit: fill;
                colorize: #00000000;
            }

            Rectangle {
                visible: root.playhead_visible;
                width: 2px;
                height: parent.height;
                x: (root.playhead_position * parent.width) - (self.width / 2);
                background: #3399ff;
                z: 1;
            }

            if root.selection_visible : selection_overlay := Rectangle {
                x: root.selection_start * wave_area.width;
                width: (root.selection_end - root.selection_start) * wave_area.width;
                height: parent.height;
                z: 3;
                background: #1c3f6a55;
                border-width: 1px;
                border-color: #3a82c4aa;

                Rectangle {
                    width: parent.width;
                    height: parent.height;
                    background: #10376155;
                }

                handle_start := Rectangle {
                    width: 4px;
                    height: parent.height;
                    x: -(self.width / 2);
                    background: #4ba3ffcc;
                    border-radius: 2px;
                    z: 4;
                    TouchArea {
                        width: parent.width;
                        height: parent.height;
                        pointer-event(event) => {
                            if event.kind == PointerEventKind.down {
                                root.selection_handle_pressed(true);
                            } else if event.kind == PointerEventKind.move {
                                root.selection_drag_updated(
                                    (selection_overlay.x
                                        + handle_start.x
                                        + self.mouse-x)
                                        / wave_area.width,
                                );
                            } else if event.kind == PointerEventKind.up {
                                root.selection_drag_finished();
                            }
                        }
                    }
                }

                handle_end := Rectangle {
                    width: 4px;
                    height: parent.height;
                    x: parent.width - (self.width / 2);
                    background: #4ba3ffcc;
                    border-radius: 2px;
                    z: 4;
                    TouchArea {
                        width: parent.width;
                        height: parent.height;
                        pointer-event(event) => {
                            if event.kind == PointerEventKind.down {
                                root.selection_handle_pressed(false);
                            } else if event.kind == PointerEventKind.move {
                                root.selection_drag_updated(
                                    (selection_overlay.x
                                        + handle_end.x
                                        + self.mouse-x)
                                        / wave_area.width,
                                );
                            } else if event.kind == PointerEventKind.up {
                                root.selection_drag_finished();
                            }
                        }
                    }
                }
            }

            Rectangle {
                visible: ta_wave.has-hover;
                width: 2px;
                height: parent.height;
                x: ta_wave.mouse-x - (self.width / 2);
                background: #66ccff;
                z: 2;
            }

            ta_wave := TouchArea {
                width: parent.width;
                height: parent.height;
                z: 1;
                pointer-event(event) => {
                    if event.kind == PointerEventKind.down && event.modifiers.shift {
                        root.selection_drag_active = true;
                        root.selection_drag_moved = false;
                        root.selection_drag_started(self.mouse-x / self.width);
                    } else if event.kind == PointerEventKind.move
                        && root.selection_drag_active
                        && event.modifiers.shift
                    {
                        root.selection_drag_moved = true;
                        root.selection_drag_updated(self.mouse-x / self.width);
                    } else if event.kind == PointerEventKind.up {
                        if root.selection_drag_active {
                            root.selection_drag_active = false;
                            root.selection_drag_finished();
                        }
                        if event.modifiers.shift && !root.selection_drag_moved {
                            root.selection_clear_requested();
                        } else if !event.modifiers.shift {
                            root.seek_requested(self.mouse-x / self.width);
                        }
                        root.selection_drag_moved = false;
                    }
                }
            }
        }
    }
}
