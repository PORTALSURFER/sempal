import { ListView } from "std-widgets.slint";
import { CollectionRow, CollectionSampleRow } from "types.slint";

export component CollectionPanel inherits Rectangle {
    in-out property <[CollectionRow]> collections;
    in-out property <[CollectionSampleRow]> collection_samples;
    in-out property <int> selected_collection: -1;
    in-out property <string> dragging_sample_path: "";
    in-out property <string> drag_preview_label: "";
    in-out property <length> drag_preview_x: 0px;
    in-out property <length> drag_preview_y: 0px;
    in-out property <bool> drag_preview_visible: false;
    in-out property <bool> collections_enabled: true;
    in-out property <bool> drop_active: false;
    callback add_collection();
    callback collection_selected(int);
    callback sample_dropped_on_collection(string, string);

    property <bool> drop_ready: root.collections_enabled
        && root.dragging_sample_path != ""
        && root.selected_collection >= 0;
    property <string> current_collection_id: {
        if root.selected_collection >= 0
            && root.selected_collection < root.collections.length
        {
            root.collections[root.selected_collection].id
        } else {
            ""
        }
    };

    width: 260px;
    vertical-stretch: 1;
    background: #101010;
    border-width: 1px;
    border-color: #303030;
    border-radius: 6px;

    VerticalLayout {
        padding: 8px;
        spacing: 10px;

        HorizontalLayout {
            spacing: 6px;
            Text {
                text: "Collections";
                color: #e0e0e0;
            }
            Rectangle {
                width: 22px;
                height: 22px;
                background: root.collections_enabled ? #2168c4 : #2a2a2a;
                border-radius: 6px;
                HorizontalLayout {
                    Text {
                        text: "+";
                        width: parent.width;
                        height: parent.height;
                        horizontal-alignment: center;
                        vertical-alignment: center;
                        color: #ffffff;
                    }
                }
                TouchArea {
                    width: parent.width;
                    height: parent.height;
                    enabled: root.collections_enabled;
                    clicked => { root.add_collection(); }
                }
            }
            Rectangle {
                horizontal-stretch: 1;
                height: 1px;
                background: #00000000;
            }
        }

        if !root.collections_enabled : Rectangle {
            vertical-stretch: 1;
            background: #0d0d0d;
            border-radius: 6px;
            HorizontalLayout {
                padding: 12px;
                Text {
                    text: "Collections feature disabled";
                    color: #7c7c7c;
                    horizontal-alignment: center;
                    vertical-alignment: center;
                }
            }
        }

        Rectangle {
            height: root.collections_enabled ? 160px : 0px;
            visible: root.collections_enabled;
            horizontal-stretch: 1;
            background: #0b0b0b;
            border-width: 1px;
            border-color: #303030;
            border-radius: 6px;
            clip: true;
            ListView {
                for collection[i] in root.collections: Rectangle {
                    height: 34px;
                    horizontal-stretch: 1;
                    background: ta_collection.pressed ? #1c1c1c :
                        (collection.selected ? #1a2733 :
                        (root.dragging_sample_path != "" && ta_collection.has-hover ? #1e2f48 :
                        (ta_collection.has-hover ? #141414 : #0f0f0f)));
                    border-width: collection.selected ? 1px : 0px;
                    border-color: #2f6fb1;
                    HorizontalLayout {
                        padding: 8px;
                        spacing: 8px;
                        Text {
                            text: collection.name;
                            color: #e0e0e0;
                            horizontal-stretch: 1;
                        }
                        Rectangle {
                            width: 26px;
                            height: 22px;
                            border-radius: 11px;
                            background: #1b1b1b;
                            border-width: 1px;
                            border-color: #2f2f2f;
                            Text {
                                text: collection.count;
                                color: #c8c8c8;
                                width: parent.width;
                                height: parent.height;
                                vertical-alignment: center;
                                horizontal-alignment: center;
                            }
                        }
                    }
                    ta_collection := TouchArea {
                        width: parent.width;
                        height: parent.height;
                        pointer-event(event) => {
                            if event.kind == PointerEventKind.up
                                && root.dragging_sample_path != ""
                            {
                                root.sample_dropped_on_collection(
                                    collection.id,
                                    root.dragging_sample_path,
                                );
                                root.drag_preview_visible = false;
                            }
                        }
                        clicked => { root.collection_selected(i); }
                    }
                }
            }
        }

        drop_zone := Rectangle {
            height: root.collections_enabled ? 150px : 0px;
            visible: root.collections_enabled;
            horizontal-stretch: 1;
            background: root.drop_active ? #1e2f48 :
                (root.drop_ready && drop_hover.has-hover ? #1a2840 :
                (root.drop_ready ? #142133 : #0b0b0b));
            border-width: 1px;
            border-color: root.drop_active ? #3b82c4 :
                (root.drop_ready && drop_hover.has-hover ? #325b88 :
                (root.drop_ready ? #2a3f5c : #303030));
            border-radius: 6px;
            clip: true;

            VerticalLayout {
                padding: 10px;
                spacing: 6px;
                Text {
                    text: root.selected_collection >= 0 ?
                        "Drop sample to add" : "Select a collection";
                    color: root.drop_ready ? #b7d6ff : #c0c0c0;
                }
                Rectangle {
                    horizontal-stretch: 1;
                    vertical-stretch: 1;
                    background: #00000000;
                    border-radius: 6px;
                    drop_hover := TouchArea {
                        width: parent.width;
                        height: parent.height;
                        enabled: root.collections_enabled;
                    }
                }
            }
        }

        Rectangle {
            horizontal-stretch: 1;
            vertical-stretch: 1;
            visible: root.collections_enabled;
            background: #0b0b0b;
            border-width: 1px;
            border-color: #303030;
            border-radius: 6px;
            clip: true;
            VerticalLayout {
                padding: 8px;
                spacing: 6px;
                Text {
                    text: "Collection items";
                    color: #d0d0d0;
                }
                ListView {
                    for sample in root.collection_samples: Rectangle {
                        height: 30px;
                        horizontal-stretch: 1;
                        background: #0f0f0f;
                        border-color: #1f1f1f;
                        border-width: 1px;
                        border-radius: 4px;
                        HorizontalLayout {
                            padding: 6px;
                            spacing: 6px;
                            Text {
                                text: sample.source;
                                color: #9ab4d0;
                            }
                            Text {
                                text: sample.path;
                                color: #e0e0e0;
                                horizontal-stretch: 1;
                            }
                        }
                    }
                }
            }
        }
    }

    public function update_drag_hover(path: string, _global_x: length, _global_y: length, active: bool) {
        root.drop_active = active && root.drop_ready && path != "" && drop_hover.has-hover;
    }

    public function try_drop(path: string, _global_x: length, _global_y: length) -> bool {
        if !root.drop_ready || root.current_collection_id == "" || path == "" {
            root.drop_active = false;
            return false;
        }
        let inside = drop_hover.has-hover;
        root.drop_active = inside;
        if inside {
            root.sample_dropped_on_collection(root.current_collection_id, path);
            return true;
        }
        false
    }
}
